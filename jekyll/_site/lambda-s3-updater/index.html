<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Lambda S3 Website Auto-Updater – Ryan Wise</title> <meta name="description" content="Full time software engineer, with freelance on the side. I do a lot of side projects involving electronics and technologies I find interesting. In addition I have a passion for cars, motorcycles and motorsport, I enjoy working on them and competing in events."> <meta name="keywords" content="S3, Github, Python, Lambda, AWS"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="/assets/img/projects/aws+github.png"> <meta name="twitter:title" content="Lambda S3 Website Auto-Updater"> <meta name="twitter:description" content="Whenever a push is made to my website repo, this Lambda function updates my website with the build"> <meta name="twitter:site" content="@leobeosab"> <meta name="twitter:creator" content="@leobeosab"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Lambda S3 Website Auto-Updater"> <meta property="og:description" content="Whenever a push is made to my website repo, this Lambda function updates my website with the build"> <meta property="og:url" content="/lambda-s3-updater/"> <meta property="og:site_name" content="Ryan Wise"> <meta property="og:image" content="/assets/img/logo.png"> <link rel="canonical" href="/lambda-s3-updater/"> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ryan Wise Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- JS --> <script src="/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="/favicon.png"> <link rel="shortcut icon" href="/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <style type="text/css">.feature {background-image:url(/assets/img/projects/aws+github.png);}</style> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140286077-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-140286077-1'); </script> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="/">Home</a></li> <li><a href="/about/">About</a></li> <li><a href="/projects/">Projects</a></li> <li><a href="/posts/">Posts</a></li> </ul> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title feature "> <h1>Lambda S3 Website Auto-Updater</h1> <h4>15 May 2019</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~2 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="updating-an-s3-bucket-with-lambda">Updating an S3 bucket with Lambda</h1> <h2 id="why">Why</h2> <p>I got tired of having to take my build directory and manually put it in S3, make it public and create a fucking CloudFront invalidation everytime I wanted to make a little change to my website [I’m very lazy]. In addition to the fact I could make a post about it and learn more about interacting with S3 services from within Lambda.</p> <h2 id="how">How</h2> <p>Code and <del>cocaine</del> <strong>coffee</strong>, how else?</p> <p>This is just a basic AWS Lambda function wirtten in Python 3.7 using no extra libraries not included with Lambda’s runtime. Everytime someone pushes to my website repo Github sends out a PUSH event using a <a href="https://developer.github.com/webhooks/">Webhook</a> which hits an API published on AWS’ API Gateway activating said lambda function.</p> <p>All this code does is download the zip file of the repo (it’s gotta be public or you’ll have to handle some auth stuff), Go through each file and check if it’s part of the build directory (there are better ways of doing this, I’m lazy), upload each file to S3, and finally create an invalidation in Cloud Front so it doesn’t show cached files. Feel free to take this code and use it however the hell you want. License: <a href="http://www.wtfpl.net">WTFPL</a></p> <h2 id="the-code--github-link">The Code + Github link</h2> <p><a href="https://github.com/leobeosab/AWSAPITools/tree/master/functions/PortGitToS3">Github</a></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>

<span class="k">def</span> <span class="nf">getFileFromGit</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">urlopen</span><span class="p">(</span><span class="s">"https://github.com/leobeosab/RyanWise.Me/archive/master.zip"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">invalidateAllCFFiles</span><span class="p">(</span><span class="n">fileList</span><span class="p">):</span>
    <span class="n">distID</span> <span class="o">=</span> <span class="s">"E8G7ATUPBJEIE"</span>

    <span class="n">cloudFrontConn</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">'cloudfront'</span><span class="p">)</span>
    <span class="n">cloudFrontConn</span><span class="o">.</span><span class="n">create_invalidation</span><span class="p">(</span>
        <span class="n">DistributionId</span><span class="o">=</span><span class="n">distID</span><span class="p">,</span> 
        <span class="n">InvalidationBatch</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'Paths'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'Quantity'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileList</span><span class="p">),</span>
                <span class="s">'Items'</span><span class="p">:</span> <span class="n">fileList</span>
            <span class="p">},</span>
            <span class="s">'CallerReference'</span><span class="p">:</span> <span class="s">'Lambda:'</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="p">})</span>

<span class="k">def</span> <span class="nf">uploadZipToS3</span><span class="p">():</span>
    <span class="n">s3Target</span> <span class="o">=</span> <span class="s">'ryanwise.me'</span> <span class="c">#bucket name</span>
    <span class="n">buildFolder</span> <span class="o">=</span> <span class="s">'/_site/'</span> <span class="c">#build subdir</span>

    <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">'s3'</span><span class="p">)</span>
    
    <span class="n">putObjects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">getFileFromGit</span><span class="p">())</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">infolist</span><span class="p">():</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">filePath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">buildFolder</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">filePath</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">filePath</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span> 
                    <span class="c">#We only want the _site/* files with no path before it</span>
                    <span class="k">continue</span>

                <span class="n">fileName</span> <span class="o">=</span> <span class="n">filePath</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c">#Guess the mime type</span>
                <span class="n">mimetype</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mimetype</span> <span class="o">=</span> <span class="s">'binary/octet-stream'</span>

                <span class="n">putFile</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">s3Target</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">fileName</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="n">zipf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">file</span><span class="p">),</span> <span class="n">ACL</span><span class="o">=</span><span class="s">'public-read'</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">=</span><span class="n">mimetype</span><span class="p">)</span>

                <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/'</span> <span class="o">+</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="n">putObjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">putFile</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">putObjects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">invalidateAllCFFiles</span><span class="p">(</span><span class="n">fileList</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"Success!"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Error"</span>

<span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="n">body</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">statusCode</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="k">try</span><span class="p">:</span>
       <span class="n">body</span> <span class="o">=</span> <span class="n">uploadZipToS3</span><span class="p">()</span> 
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">statusCode</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'statusCode'</span><span class="p">:</span> <span class="n">statusCode</span><span class="p">,</span>
        <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div> <h2 id="follow-me">Follow me</h2> <p>Follow me, my friends, dumb memes, interesting tech topics and way too much car stuff.</p> <p>Github <a href="https://github.com/leobeosab">@leobeosab</a> &amp; Twitter <a href="https://twitter.com/ride_faster">@ride_faster</a></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="/tags/#S3" title="Pages tagged S3" class="tag"><span class="term">S3</span></a><a href="/tags/#Github" title="Pages tagged Github" class="tag"><span class="term">Github</span></a><a href="/tags/#Python" title="Pages tagged Python" class="tag"><span class="term">Python</span></a><a href="/tags/#Lambda" title="Pages tagged Lambda" class="tag"><span class="term">Lambda</span></a><a href="/tags/#AWS" title="Pages tagged AWS" class="tag"><span class="term">AWS</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=/lambda-s3-updater/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=/lambda-s3-updater/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=/lambda-s3-updater/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="/assets/js/jquery-1.12.0.min.js"></script> <script src="/assets/js/jquery.dlmenu.min.js"></script> <script src="/assets/js/jquery.goup.min.js"></script> <script src="/assets/js/jquery.magnific-popup.min.js"></script> <script src="/assets/js/jquery.fitvid.min.js"></script> <script src="/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'ryanwise-me'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
